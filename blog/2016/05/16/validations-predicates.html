<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Hanami - The web, with simplicity" />
<meta name="keywords" content="hanami,hanamirb,lotus,lotusrb,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare"/>
<meta name="author" content="Luca Guidi">
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<link href="/atom.xml" rel="alternate" title="Hanami" type="application/atom+xml" />

<title>Hanami | Validations Predicates</title>

<link href="http://fonts.googleapis.com/css?family=Roboto:100,300,400,700" rel="stylesheet">
<link href="/stylesheets/toolkit-minimal.css" rel="stylesheet" />
<link href="/stylesheets/application-minimal.css" rel="stylesheet" />

    <meta property="og:site_name"   content="Hanami"/>
    <meta property="og:title"       content="Validations Predicates">
    <meta property="og:url"         content="http://hanamirb.org/blog/2016/05/16/validations-predicates.html">
    <meta property="og:description" content="Hanami will introduce a new syntax for validations based on predicates. It features builtin and custom predicates, type safety, specific coercions for HTTP params, whitelisting, custom error messages with optional i18n support. This release will start a new alliance between Hanami and dry-rb.
">
    <meta property="og:image"       content="http://hanamirb.org/blog/2016/05/16/validations-predicates/cover.jpg">

    <meta name="twitter:card"        content="summary_large_image">
    <meta name="twitter:site"        content="@hanamirb">
    <meta name="twitter:creator"     content="@hanamirb">
    <meta name="twitter:url"         content="http://hanamirb.org/blog/2016/05/16/validations-predicates.html">
    <meta name="twitter:title"       content="Validations Predicates">
    <meta name="twitter:description" content="Hanami will introduce a new syntax for validations based on predicates. It features builtin and custom predicates, type safety, specific coercions for HTTP params, whitelisting, custom error messages with optional i18n support. This release will start a new alliance between Hanami and dry-rb.
">
    <meta name="twitter:image:src"   content="http://hanamirb.org/blog/2016/05/16/validations-predicates/cover.jpg">
  </head>

  <body>
    <nav class="navbar navbar-default navbar-static-top navbar-padded text-uppercase app-navbar">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed p-x-0" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <span>Hanami</span>
      </a>
    </div>
    <div class="navbar-collapse collapse" id="navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/guides">Guides</a>
        </li>
        <li>
          <a href="/community">Community</a>
        </li>
        <li>
          <a href="/donate">Donate</a>
        </li>
        <li>
          <a href="https://github.com/hanami" target="_blank">Source Code</a>
        </li>
        <li>
          <a href="/blog">Blog</a>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <div class="container">
      <div class="block block-inverse text-center">
        <div class="block-foreground">
          <h1 class="block-title">Validations Predicates</h1>
          <h4 class="text-muted">Posted by <strong>Luca Guidi</strong> on <em>May 16, 2016</em></h4>
          <button class="btn btn-default btn-outline m-t">
            <span class="icon icon-facebook"></span>
            Share
          </button>
          <button class="btn btn-default btn-outline m-t">
            <span class="icon icon-twitter"></span>
            Tweet
          </button>
        </div>
        <div class="block-background">
          <img src="/blog/2016/05/16/validations-predicates/cover.jpg">
        </div>
      </div>

      <div class="container container-article">
        <div class="row">
          <div class="col-xs-12 col-md-8 col-md-offset-1">
            <p class="lead">Hanami will introduce a new syntax for validations based on predicates. It features builtin and custom predicates, type safety, specific coercions for HTTP params, whitelisting, custom error messages with optional i18n support. This release will start a new alliance between Hanami and dry-rb.
</p>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-xs-12 col-md-9 col-md-offset-1">
            <div class="article-body">
              <p>For long time <a href="https://github.com/hanami/validations">Hanami::Validations</a> had problems that we struggled to solve and new features were problematic to add.
Data management is complex task with thousands of cases to cover and because validations deal untrusted input, edge cases are common.
Even simple cases like <em>blank values</em> management became an issue.</p>

<p>We tried to fix these problems, but over the time we realized that we hit the limit of that syntax, which led to lack of flexibility for us and for developers themselves.</p>

<p>At the same time <a href="http://dry-rb.org">dry-rb</a> folks released a new, stronger validations gem: <code>dry-validation</code>.
It changes, for the good, the way we express validation rules.
So we took the decision to radically change our syntax and to adopt <code>dry-validation</code> as a validations backend for us.</p>

      <h2 id="how-it-will-work-" class="title"><a name="how-it-will-work-" class="anchor" href="#how-it-will-work-">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>How It Will Work?</h2>
    
<p><code>Hanami::Validations</code> will work with input hashes and let define a set of validation rules <strong>for each</strong> key/value pair.
These rules are wrapped by lambdas (or special DSL) that check the input for a specific key to determine if it&#39;s valid or not.
To do that, we translate business requirements into predicates that are chained together with Ruby <em>faux boolean logic</em> operators (eg. <code>&amp;</code> or <code>|</code>).</p>

<p>Think of a signup form.
We need to ensure data integrity for the  <code>name</code> field with the following rules.
It is required, it has to be: filled <strong>and</strong> a string <strong>and</strong> its size must be greater than 3 chars, but lesser than 64.
Hereâ€™s the code, <strong>read it aloud</strong> and notice how it perfectly expresses our needs for <code>name</code>.</p>
<pre class="language-ruby ruby"><code><span class="k">class</span> <span class="nc">Signup</span>
  <span class="kp">include</span> <span class="no">Hanami</span><span class="o">::</span><span class="no">Validations</span>

  <span class="n">validations</span> <span class="k">do</span>
    <span class="n">required</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">{</span> <span class="n">filled?</span> <span class="o">&amp;</span> <span class="n">str?</span> <span class="o">&amp;</span> <span class="n">size?</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nf">.</span><span class="mi">64</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">result</span> <span class="o">=</span> <span class="no">Signup</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Luca"</span><span class="p">).</span><span class="nf">validate</span>
<span class="n">result</span><span class="p">.</span><span class="nf">success?</span> <span class="c1"># =&gt; true</span>

<span class="n">result</span> <span class="o">=</span> <span class="no">Signup</span><span class="p">.</span><span class="nf">new</span><span class="p">({}).</span><span class="nf">validate</span>

<span class="n">result</span><span class="p">.</span><span class="nf">success?</span> <span class="c1"># =&gt; false</span>
<span class="n">result</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="c1"># =&gt; ["must be filled"]</span>
</code></pre>

      <h3 id="boolean-logic" class="title"><a name="boolean-logic" class="anchor" href="#boolean-logic">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Boolean Logic</h3>
    
<p>When we check data, we expect only two outcomes: an input can be valid or not.
No grey areas, nor fuzzy results.
Itâ€™s white or black, 1 or 0, <code>true</code> or <code>false</code> and <em>boolean logic</em> is the perfect tool to express these two states.
Indeed, a Ruby <em>boolean expression</em> can only return <code>true</code> or <code>false</code>.</p>

<p>To better recognise the pattern, letâ€™s get back to the example above.
This time we will map the natural language rules with programming language rules.</p>
<pre class="language-ruby ruby"><code>        <span class="no">A</span> <span class="nb">name</span> <span class="n">must</span> <span class="n">be</span> <span class="n">filled</span>  <span class="n">and</span> <span class="n">be</span> <span class="n">a</span> <span class="n">string</span> <span class="n">and</span> <span class="n">its</span> <span class="n">size</span> <span class="n">fall</span> <span class="n">between</span> <span class="mi">3</span> <span class="n">and</span> <span class="mi">64</span><span class="o">.</span>
           <span class="err">ðŸ‘‡</span>            <span class="err">ðŸ‘‡</span>     <span class="err">ðŸ‘‡</span>        <span class="err">ðŸ‘‡</span>    <span class="err">ðŸ‘‡</span>       <span class="err">ðŸ‘‡</span>                <span class="err">ðŸ‘‡</span>    <span class="err">ðŸ‘‡</span>
<span class="n">required</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>      <span class="p">{</span> <span class="n">filled?</span>  <span class="o">&amp;</span>       <span class="n">str?</span>   <span class="o">&amp;</span>      <span class="n">size?</span>              <span class="p">(</span><span class="mi">3</span> <span class="p">.</span><span class="nf">.</span> <span class="mi">64</span><span class="p">)</span> <span class="p">}</span>
</code></pre>

<p>Now, I hope youâ€™ll never format code like that, but in this case, that formatting serves well our purpose to show how Rubyâ€™s  simplicity helps to define complex rules with no effort.</p>

<p>From a high level perspective, we can tell that input data for <code>name</code> is <em>valid</em> only if <strong>all</strong> the requirements are satisfied. Thatâ€™s because we used <code>&amp;</code>.</p>

<p>But there is more. Rule composition with blocks is powerful, but it can become verbose.
To <strong>reduce verbosity</strong>, Hanami offers convenient macros that are internally expanded (aka interpreted) to an equivalent block expression.</p>
<pre class="language-ruby ruby"><code><span class="n">required</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">filled</span><span class="p">(</span><span class="ss">:str?</span><span class="p">,</span> <span class="n">size?</span><span class="p">:</span> <span class="mi">3</span><span class="p">.</span><span class="nf">.</span><span class="mi">64</span><span class="p">)</span>
</code></pre>

      <h3 id="the-advantages" class="title"><a name="the-advantages" class="anchor" href="#the-advantages">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>The Advantages</h3>
    
<p>With this new syntax we give more control to developers: they can decide the order of execution of the validations.
They can define <a href="https://github.com/hanami/validations#custom-predicates">custom predicates</a> and <a href="https://github.com/hanami/validations#messages">custom error messages</a>, <a href="https://github.com/hanami/validations#internationalization-i18n">opt in for internationalization (i18n)</a> with small effort.
They can <a href="https://github.com/hanami/validations#macros">dry code via macros</a>, <a href="https://github.com/hanami/validations#composition">reuse validators</a>, <a href="https://github.com/hanami/validations#type-safety">enforce types</a>, <a href="https://github.com/hanami/validations#whitelisting">whitelist params</a>.</p>

<p>To summarize: we fixed old bugs, implemented features that developers asked for, increased internal code robustness and started a new alliance with <strong>dry-rb</strong> &lt;3.</p>

<p><strong>These chances were just merged in <a href="https://github.com/hanami/validations">master</a> and they will be released in a few months with <code>hanami</code> <code>v0.8.0</code>.</strong></p>

            </div>

           <hr>

           <a href="https://github.com/hanami/hanami" title="Star on GitHub" target="_blank" class="btn btn-default-outline">
             <span class="icon icon-github"></span>
             Star
           </a>
           <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fhanamirb.org%2Fblog%2F2016%2F05%2F16%2Fvalidations-predicates.html" title="Like on Facebook" class="btn btn-default-outline" target="_blank">
             <span class="icon icon-thumbs-up"></span>
             Like
           </a>
           <a href="https://twitter.com/home?status=Validations+Predicates+-+http%3A%2F%2Fhanamirb.org%2Fblog%2F2016%2F05%2F16%2Fvalidations-predicates.html+%2Fvia+%40hanamirb+%23hanamirb" title="Share on Twitter" target="_blank" class="btn btn-default-outline">
             <span class="icon icon-twitter"></span>
             Tweet
           </a>
           <a href="https://news.ycombinator.com/submitlink?u=http%3A%2F%2Fhanamirb.org%2Fblog%2F2016%2F05%2F16%2Fvalidations-predicates.html&t=Validations Predicates" class="btn btn-default-outline" title="Vote on HackerNews">
             <span class="icon"><strong>HN</strong></span>
             Vote
           </a>
            <a href="http://www.reddit.com/submit?url=http%3A%2F%2Fhanamirb.org%2Fblog%2F2016%2F05%2F16%2Fvalidations-predicates.html" target="_blank" title="Share on Reddit" class="btn btn-default-outline">
             <span class="icon"><strong>R</strong></span>
             Share
            </a>

            <br>
            <br>

            <div class="block block-bordered-lg text-center">
  <div class="container-fluid">
    <p class="lead m-b-md">
    Join a community of over 2,000+ developers.
    </p>
    <form action="http://hanamirb.us3.list-manage.com/subscribe/post" method="POST" class="form-inline">
      <input name="u" value="dcbeefa4ba1ea9ae043857005" type="hidden">
      <input name="id" value="fb3873a90f" type="hidden">
      <input name="orig-lang" value="1" type="hidden">
      <input type="email" class="form-control m-b" placeholder="Email Address" spellcheck="false" autocapitalize="off" autocorrect="off" name="MERGE0" id="MERGE0" value="">
      <button class="btn btn-primary m-b">Subscribe</button>
    </form>
    <small class="text-muted">
      By clicking "Subscribe" I want to subscribe to Hanami mailing list.
    </small>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>

    <div id="lotus" class="text-xs-center">
  <div class="container">
    <div class="row">
      Looking for <strong>Lotus</strong>? We renamed the project and it's now called <strong>Hanami</strong>. Read the <a href="/blog/2016/01/22/lotus-is-now-hanami.html">announcement</a>.
    </div>
  </div>
</div>


<div class="block app-block-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <li><h6 class="text-uppercase">Project</h6></li>
          <li><a href="https://github.com/hanami" target="_blank">GitHub</a></li>
          <li><a href="https://twitter.com/hanamirb" target="_blank">Twitter</a></li>
          <li><a href="https://rubygems.org/gems/hanami" target="_blank">Rubygems</a></li>
          <li><a href="/status" target="_blank">Gems Status</a></li>
        </ul>
      </div>
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <li><h6 class="text-uppercase">Community</h6></li>
          <li><a href="/community#code-of-conduct">Code of Conduct</a></li>
          <li><a href="http://chat.hanamirb.org" target="_blank">Chat</a></li>
          <li><a href="https://discourse.hanamirb.org" target="_blank">Forum</a></li>
          <li><a href="https://stackoverflow.com/questions/tagged/hanami" target="_blank">StackOverflow</a></li>
          <li><a href="/mailing-list">Mailing List</a></li>
          <li><a href="http://awesome-hanami.org" target="_blank">Awesome List</a></li>
        </ul>
      </div>
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <a href="http://dnsimple.link/resolving-hanami" target="_blank">
            <span>Resolving with<br/></span>
            <img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="display:block;margin:0;padding:0;width:100px;"/>
          </a>
        </ul>
      </div>
      <div class="col-sm-6">
        <h6 class="text-uppercase">About</h6>
        <p>
          Hanami is a web framework for Ruby &mdash; &copy; 2014-2017 <a href="http://lucaguidi.com" target="_blank">Luca Guidi</a>.<br>
          Released under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>.
          <br><br>
          This project was formerly known as <strong>Lotus</strong>.
        </p>
      </div>
    </div>
  </div>
</div>
<script src="/javascripts/jquery.min.js" type="text/javascript"></script>
<script src="/javascripts/toolkit.js" type="text/javascript"></script>
<script src="/javascripts/application.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47369640-1', 'hanamirb.org');
  ga('send', 'pageview');
</script>

<script>
  ((window.gitter = {}).chat = {}).options = { room: 'hanami/chat' };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  </body>
</html>
