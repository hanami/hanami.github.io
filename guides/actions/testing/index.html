<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Lotus - Guides - Action Testing</title>
    <meta name="description" content="Lotus, a complete web framework for Ruby" />
    <meta name="keywords" content="lotus,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://feeds.feedburner.com/lotusrb" rel="alternate" title="Lotus" type="application/atom+xml" />

    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />

    <script src="//use.typekit.net/xhp5wmc.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body class="subpage docs">
    <!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<nav class="navbar navbar-fixed-top container-fluid">
  <div class="wrapper container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Logo</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <!-- <li><a href="/guides">Guides</a></li> -->
        <li><a href="/community">Community</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://rubygems.org/gems/lotusrb" id="nav-link-install" target="_blank" class="btn btn-primary version">Install v0.3.2</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <section class="docs wrapper animated fadeIn">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3 hidden-sm hidden-xs sidebar">
            <ul class="nav nav-sidebar">
              <li>
                <span class="heading">Routing</span>
                <ul class="nav">
                  <li><a href="/guides/routing/overview">Overview</a></li>
                  <li><a href="/guides/routing/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/routing/restful-resources">RESTful Resource(s)</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Actions</span>
                <ul class="nav">
                  <li><a href="/guides/actions/overview">Overview</a></li>
                  <li><a href="/guides/actions/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/actions/parameters">Parameters</a></li>
                  <li><a href="/guides/actions/request-and-response">Request & Response</a></li>
                  <li><a href="/guides/actions/exposures">Exposures</a></li>
                  <li><a href="/guides/actions/rack-integration">Rack Integration</a></li>
                  <li><a href="/guides/actions/mime-types">MIME Types</a></li>
                  <li><a href="/guides/actions/cookies">Cookies</a></li>
                  <li><a href="/guides/actions/sessions">Sessions</a></li>
                  <li><a href="/guides/actions/exception-handling">Exception Handling</a></li>
                  <li><a href="/guides/actions/control-flow">Control Flow</a></li>
                  <li><a href="/guides/actions/http-caching">HTTP Caching</a></li>
                  <li><a href="/guides/actions/share-code">Share Code</a></li>
                  <li><a href="/guides/actions/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Views</span>
                <ul class="nav">
                  <li><a href="/guides/views/overview">Overview</a></li>
                  <li><a href="/guides/views/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/views/templates">Templates</a></li>
                  <li><a href="/guides/views/partials">Partials</a></li>
                  <li><a href="/guides/views/mime-types">MIME Types</a></li>
                  <li><a href="/guides/views/layouts">Layouts</a></li>
                  <li><a href="/guides/views/custom-error-pages">Custom Error Pages</a></li>
                  <li><a href="/guides/views/share-code">Share Code</a></li>
                  <li><a href="/guides/views/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Helpers</span>
                <ul class="nav">
                  <li><a href="/guides/helpers/overview">Overview</a></li>
                  <li><a href="/guides/helpers/html5">HTML5</a></li>
                  <li><a href="/guides/helpers/forms">Forms</a></li>
                  <li><a href="/guides/helpers/routing">Routing</a></li>
                  <li><a href="/guides/helpers/links">Links</a></li>
                  <li><a href="/guides/helpers/escape">Markup Escape</a></li>
                  <li><a href="/guides/helpers/numbers">Numbers</a></li>
                  <li><a href="/guides/helpers/custom-helpers">Custom Helpers</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Command Line</span>
                <ul class="nav">
                  <li><a href="/guides/command-line/routes">Routes</a></li>
                </ul>
              </li>
            </ul>

          </div>

          <div class="col-md-9 main">
            <div class="doc-section">
              <a href="https://github.com/lotus/lotus.github.io/edit/build//source/guides/actions/testing.md" id="edit-guides-article" title="Edit this article" target="_blank">edit</a>
              <h1>Testing</h1>

<p>Lotus pays a lot of attention to code testability and it offers advanced features to make our lives easier.
The framework supports Minitest (default) and RSpec.</p>

<h2>Unit Tests</h2>

<p>First of all, actions can be unit tested.
That means we can instantiate, excercise and verify expectations <strong>directly on actions instances</strong>.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/dashboard/index_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/dashboard/index'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Dashboard</span><span class="o">::</span><span class="no">Index</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span> <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Dashboard</span><span class="o">::</span><span class="no">Index</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="p">{</span> <span class="no">Hash</span><span class="p">[]</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span> <span class="mi">200</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In the example above, <code>action</code> is an instance of <code>Web::Controllers::Dashboard::Index</code>, we can invoke <code>#call</code> on it, passing a Hash of parameters.
The <a href="/guides/actions/rack-integration">implicit returning value</a> is a serialized Rack response.
We&rsquo;re asserting that the status code (<code>response[0]</code>) is successful (equals to <code>200</code>).</p>

<h3>Running Tests</h3>

<p>We can run the entire test suite or a single file.</p>

<p>The default Rake task for the application serves for our first case: <code>bundle exec rake</code>.
All the dependencies and the application code (actions, views, entities, etc..) are eagerly loaded.
<strong>Boot time is slow in this case.</strong></p>

<p class="notice">
The entire test suite can be run via default Rake task. It loads all the dependencies, and the application code.
</p>

<p>The second scenario can be done via: <code>ruby -Ispec spec/web/controllers/dashboard/index_spec.rb</code> (or <code>rspec spec/web/controllers/dashboard/index_spec.rb</code> if we use RSpec).
When we run a single file example <strong>only the framework and the application settings are loaded</strong>.</p>

<p>Please note the <code>require_relative</code> line in the example.
It&rsquo;s <strong>auto generated for us</strong> and it&rsquo;s needed to load the current action under test.
This mechanism allows us to run unit tests in <strong>isolation</strong>.
<strong>Boot time is magnitudes faster</strong>.</p>

<p class="notice">
A single unit test can be run directly. It only loads the dependencies, but not the application code.
The class under test is loaded via <code>require_relative</code>, a line automatically generated for us.
In this way we can have a faster startup time and a shorter feedback cycle.
</p>

<h3>Params</h3>

<p>When testing an action, we can easily simulate parameters and headers coming from the request.
We just need to pass them as a Hash.
Headers for Rack env such as <code>HTTP_ACCEPT</code> can be mixed with params like <code>:id</code>.</p>

<p>The following test example uses both.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:format</span><span class="p">)</span>  <span class="p">{</span> <span class="s1">'application/json'</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'23'</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'HTTP_ACCEPT'</span> <span class="o">=&gt;</span> <span class="nb">format</span><span class="p">)</span>

    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span>                 <span class="mi">200</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Content-Type'</span><span class="p">].</span><span class="nf">must_equal</span> <span class="s2">"</span><span class="si">#{</span> <span class="nb">format</span> <span class="si">}</span><span class="s2">; charset=utf-8"</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">must_equal</span>                 <span class="p">[</span><span class="s2">"ID: </span><span class="si">#{</span> <span class="n">user_id</span> <span class="si">}</span><span class="s2">"</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Here the corresponding production code.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="n">params</span><span class="p">.</span><span class="nf">class</span> <span class="c1"># =&gt; Web::Controllers::Users::Show::Params</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="s2">"ID: </span><span class="si">#{</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
Simulating request params and headers is simple for Lotus actions. We pass them as a <code>Hash</code> and they are transformed into an instance of <code>Lotus::Action::Params</code>.
</p>

<h3>Exposures</h3>

<p>There are cases where we want to verify the internal state of an action.
Imagine we have a classic user profile page, like depicted in the example above.
The action asks for a record that corresponds to the given id, and then set a <code>@user</code> instance variable.
How do we verify that the record is the one that we are looking for?</p>

<p>Because we want to make <code>@user</code> available to the outside world, we&rsquo;re going to use an <a href="/guides/actions/exposures"><em>exposure</em></a>.
They are used to pass a data payload between an action and the corresponding view.
When we do <code>expose :user</code>, Lotus creates a getter (<code>#user</code>), so we can easily assert if the record is the right one.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">expose</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:foo</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="vi">@foo</span>  <span class="o">=</span> <span class="s1">'bar'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We have used two <em>exposures</em>: <code>:user</code> and <code>:foo</code>, let&rsquo;s verify if they are properly set.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span> <span class="mi">200</span>

    <span class="n">action</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">must_equal</span> <span class="vi">@user</span>
    <span class="n">action</span><span class="p">.</span><span class="nf">exposures</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">({</span><span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">foo: </span><span class="s1">'bar'</span><span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
The internal state of an action can be easily verified with <em>exposures</em>.
</p>

<h3>Dependency Injection</h3>

<p>During unit testing, we may want to use mocks to make tests faster or to avoid hitting external systems like databases, file system or remote services.
Because we can instantiate actions during tests, there is no need to use testing antipatterns (eg. <code>any_instance_of</code>, or <code>UserRepository.stub(:find)</code>).
Instead, we can just specify which collaborators we want to use via <em>dependency injection</em>.</p>

<p>Let&rsquo;s rewrite the test above so that it does not hit the database.
We&rsquo;re going to use RSpec for this example as it has a nicer API for mocks (doubles).</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>     <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">repository: </span><span class="n">repository</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>       <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">id: </span><span class="mi">23</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:repository</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'repository'</span><span class="p">,</span> <span class="ss">find: </span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">to</span>      <span class="n">eq</span> <span class="mi">200</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="nf">user</span><span class="p">).</span><span class="nf">to</span>      <span class="n">eq</span> <span class="n">user</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="nf">exposures</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">({</span><span class="ss">user: </span><span class="n">user</span><span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We have injected the repository dependency which is a mock in our case.
Here how to adapt our action.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">expose</span> <span class="ss">:user</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">repository: </span><span class="no">UserRepository</span><span class="p">)</span>
      <span class="vi">@repository</span> <span class="o">=</span> <span class="n">repository</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@repository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="warning">
Please be careful using doubles in unit tests. Always verify that the mocks are in a true representation of the corresponding production code.
</p>

<h2>Requests Tests</h2>

<p>Unit tests are a great tool to assert that low level interfaces works as expected.
We always advise combining them with integration tests.</p>

<p>In the case of Lotus web applications, we can write features (aka acceptance tests) with Capybara, but what do we use when we are building HTTP APIs?
The tool that we suggest is <code>rack-test</code>.</p>

<p>Imagine we have an API application mounted at <code>/api/v1</code> in our <code>Lotus::Container</code>.</p>
<pre class="language-ruby ruby"><code><span class="c1"># config/environment.rb</span>
<span class="c1"># ...</span>
<span class="no">Lotus</span><span class="o">::</span><span class="no">Container</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">mount</span> <span class="no">ApiV1</span><span class="o">::</span><span class="no">Application</span><span class="p">,</span> <span class="ss">at: </span><span class="s1">'/api/v1'</span>
  <span class="n">mount</span> <span class="no">Web</span><span class="o">::</span><span class="no">Application</span><span class="p">,</span>   <span class="ss">at: </span><span class="s1">'/'</span>
<span class="k">end</span>
</code></pre>

<p>Then we have the following action.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/api_v1/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">ApiV1::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">ApiV1</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">accept</span> <span class="ss">:json</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">to_h</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In this case we don&rsquo;t care too much about the internal state of the action, but about the output visible to the external world.
This is why we haven&rsquo;t set <code>user</code> as an instance variable and why we haven&rsquo;t exposed it.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/api_v1/requests/users_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"API V1 users"</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># app is required by Rack::Test</span>
  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Lotus</span><span class="o">::</span><span class="no">Container</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/api/v1/users/</span><span class="si">#{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="si">}</span><span class="s2">"</span>

    <span class="n">last_response</span><span class="p">.</span><span class="nf">must_be</span> <span class="ss">:ok?</span>
    <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">to_h</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
Please avoid doubles when writing full integration tests, as we want to verify that the whole stack is behaving as expected.
</p>

            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="email-signup">
  <div class="container-fluid wrapper">
    <form action="http://lotusrb.us3.list-manage.com/subscribe/post" method="POST" class="">
      <input name="u" value="dcbeefa4ba1ea9ae043857005" type="hidden">
      <input name="id" value="fb3873a90f" type="hidden">
      <input name="orig-lang" value="1" type="hidden">
      <input type="email" placeholder="Enter your email to get updates" spellcheck="false" autocapitalize="off" autocorrect="off" name="MERGE0" id="MERGE0" value="" class="pull-left">
      <button type="submit" class="btn btn-primary pull-right">Subscribe</button>
    </form>
  </div>
</section>

<footer class="primary">
  <div class="container-fluid wrapper">
    <div class="row">
      <a class="logo col-md-3" href="/">logo</a>
        <div class="col-md-4">
          <span class="date">June 15, 2015</span>
          <h4>Introducing Form Helpers</h4>
          <p>New feature for the upcoming v0.4.0: form helpers. HTML5 form generators with automatic values, CSRF protection, method override, infinite nested fields and ORM agnostic.
</p>
          <a href="/blog/2015/06/15/introducing-form-helpers.html">Read more...</a>
        </div>
        <div class="col-md-4">
          <span class="date">May 31, 2015</span>
          <h4>Weekly Changelog</h4>
          <p>Changelog from May 16 2015 to May 31 2015
</p>
          <a href="/blog/2015/05/31/weekly-changelog.html">Read more...</a>
        </div>
    </div>
  </div>

  <div class="sub-footer wrapper">
    <p class="copyright pull-left">&copy; 2014-<span id="copyright-year">{{year}}</span> <a href="http://lucaguidi.com/">Luca Guidi</a> â€“ Lotus is released under the MIT License.
    <br>
    <br> This website and its contents are released under <a href="http://creativecommons.org/licenses/by-nc/4.0/" href="_blank">CC Attribution-NonCommercial 4.0</a>.
    <br> Maintained with <3 by the <a href="https://github.com/orgs/lotus/people" target="_blank">core team</a> with help from <a href="https://github.com/lotus/lotus/graphs/contributors" target="_blank">contributors</a>. Site Design by <a href="http://www.alantippins.com/">Alan Tippins</a>.</p>
    <ul class="social">
      <li><a href="https://twitter.com/lotus_rb" target="_blank" class="icon-twitter"></a></li>
      <li><a href="https://github.com/lotus" target="_blank" class="icon-github"></a></li>
    </ul>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="javascripts/vendor/jquery-1.11.2.min.js"><\/script>')</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>

<script src="/javascripts/application.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47369640-1', 'lotusrb.org');
  ga('send', 'pageview');
</script>

  </body>
</html>
