<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Hanami - The web, with simplicity" />
<meta name="keywords" content="hanami,hanamirb,lotus,lotusrb,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare"/>
<meta name="author" content="Luca Guidi">
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<link href="/atom.xml" rel="alternate" title="Hanami" type="application/atom+xml" />

<title>Hanami | Guides - Action Testing</title>

<link href="http://fonts.googleapis.com/css?family=Roboto:100,300,400,700" rel="stylesheet">
<link href="/stylesheets/toolkit-minimal.css" rel="stylesheet" />
<link href="/stylesheets/application-minimal.css" rel="stylesheet" />

    <link href="/stylesheets/guides.css" rel="stylesheet" />
  </head>

  <body>
    <nav class="navbar navbar-default navbar-static-top navbar-padded text-uppercase app-navbar">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed p-x-0" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <span>Hanami</span>
      </a>
    </div>
    <div class="navbar-collapse collapse" id="navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/guides">Guides</a>
        </li>
        <li>
          <a href="/community">Community</a>
        </li>
        <li>
          <a href="/donate">Donate</a>
        </li>
        <li>
          <a href="https://github.com/hanami" target="_blank">Source Code</a>
        </li>
        <li>
          <a href="/blog">Blog</a>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <div class="container docs-content">
      <select class="mobile-guides">
          <optgroup label="Introduction">
              <option value="/guides/getting-started" >Getting Started</option>
          </optgroup>
          <optgroup label="Architecture">
              <option value="/guides/architecture/overview" >Overview</option>
          </optgroup>
          <optgroup label="Projects">
              <option value="/guides/projects/code-reloading" >Code Reloading</option>
              <option value="/guides/projects/rake" >Rake</option>
              <option value="/guides/projects/logging" >Logging</option>
              <option value="/guides/projects/initializers" >Initializers</option>
          </optgroup>
          <optgroup label="Routing">
              <option value="/guides/routing/overview" >Overview</option>
              <option value="/guides/routing/basic-usage" >Basic Usage</option>
              <option value="/guides/routing/restful-resources" >RESTful Resource(s)</option>
              <option value="/guides/routing/testing" >Testing</option>
          </optgroup>
          <optgroup label="Actions">
              <option value="/guides/actions/overview" >Overview</option>
              <option value="/guides/actions/basic-usage" >Basic Usage</option>
              <option value="/guides/actions/parameters" >Parameters</option>
              <option value="/guides/actions/request-and-response" >Request & Response</option>
              <option value="/guides/actions/exposures" >Exposures</option>
              <option value="/guides/actions/rack-integration" >Rack Integration</option>
              <option value="/guides/actions/mime-types" >MIME Types</option>
              <option value="/guides/actions/cookies" >Cookies</option>
              <option value="/guides/actions/sessions" >Sessions</option>
              <option value="/guides/actions/exception-handling" >Exception Handling</option>
              <option value="/guides/actions/control-flow" >Control Flow</option>
              <option value="/guides/actions/http-caching" >HTTP Caching</option>
              <option value="/guides/actions/share-code" >Share Code</option>
              <option value="/guides/actions/testing" selected>Testing</option>
          </optgroup>
          <optgroup label="Views">
              <option value="/guides/views/overview" >Overview</option>
              <option value="/guides/views/basic-usage" >Basic Usage</option>
              <option value="/guides/views/templates" >Templates</option>
              <option value="/guides/views/mime-types" >MIME Types</option>
              <option value="/guides/views/layouts" >Layouts</option>
              <option value="/guides/views/custom-error-pages" >Custom Error Pages</option>
              <option value="/guides/views/share-code" >Share Code</option>
              <option value="/guides/views/testing" >Testing</option>
          </optgroup>
          <optgroup label="Models">
              <option value="/guides/models/overview" >Overview</option>
              <option value="/guides/models/database-configuration" >Database Configuration</option>
              <option value="/guides/models/repositories" >Repositories</option>
              <option value="/guides/models/entities" >Entities</option>
              <option value="/guides/models/data-types" >Data Types</option>
              <option value="/guides/models/postgresql" >PostgreSQL</option>
              <option value="/guides/models/associations" >Associations</option>
              <option value="/guides/models/use-your-own-orm" >Use Your Own ORM</option>
          </optgroup>
          <optgroup label="Migrations">
              <option value="/guides/migrations/overview" >Overview</option>
              <option value="/guides/migrations/create-table" >Create Table</option>
              <option value="/guides/migrations/alter-table" >Alter Table</option>
          </optgroup>
          <optgroup label="Helpers">
              <option value="/guides/helpers/overview" >Overview</option>
              <option value="/guides/helpers/html5" >HTML5</option>
              <option value="/guides/helpers/forms" >Forms</option>
              <option value="/guides/helpers/routing" >Routing</option>
              <option value="/guides/helpers/assets" >Assets</option>
              <option value="/guides/helpers/links" >Links</option>
              <option value="/guides/helpers/escape" >Markup Escape</option>
              <option value="/guides/helpers/numbers" >Numbers</option>
              <option value="/guides/helpers/custom-helpers" >Custom Helpers</option>
          </optgroup>
          <optgroup label="Mailers">
              <option value="/guides/mailers/overview" >Overview</option>
              <option value="/guides/mailers/basic-usage" >Basic Usage</option>
              <option value="/guides/mailers/templates" >Templates</option>
              <option value="/guides/mailers/delivery" >Delivery</option>
              <option value="/guides/mailers/share-code" >Share Code</option>
              <option value="/guides/mailers/testing" >Testing</option>
          </optgroup>
          <optgroup label="Assets">
              <option value="/guides/assets/overview" >Overview</option>
              <option value="/guides/assets/preprocessors" >Preprocessors</option>
              <option value="/guides/assets/compressors" >Compressors</option>
              <option value="/guides/assets/content-delivery-network" >Content Delivery Network (CDN)</option>
              <option value="/guides/assets/use-your-own-assets-management-tool" >Use Your Own Assets Management Tool</option>
          </optgroup>
          <optgroup label="Command Line">
              <option value="/guides/command-line/applications" >Applications</option>
              <option value="/guides/command-line/generators" >Generators</option>
              <option value="/guides/command-line/destroy" >Destroy</option>
              <option value="/guides/command-line/database" >Database</option>
              <option value="/guides/command-line/assets" >Assets</option>
              <option value="/guides/command-line/routes" >Routes</option>
              <option value="/guides/command-line/version" >Version</option>
          </optgroup>
          <optgroup label="Upgrade Notes">
              <option value="/guides/upgrade-notes/v060" >v0.6.0</option>
              <option value="/guides/upgrade-notes/v070" >v0.7.0</option>
              <option value="/guides/upgrade-notes/v080" >v0.8.0</option>
              <option value="/guides/upgrade-notes/v090" >v0.9.0</option>
          </optgroup>
      </select>
      <ul id="markdown-toc">
        <li></li>
        <li><a href="https://github.com/hanami/hanami.github.io/edit/build/source/guides/actions/testing.md" target="_blank"><span class="icon icon-pencil" id="edit-guides-article" title="Edit this article"></span></a></li>

          <li class="toc-group">
            <span>Introduction</span>
            <ul>
                <li>
                  <a href="/guides/getting-started">Getting Started</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Architecture</span>
            <ul>
                <li>
                  <a href="/guides/architecture/overview">Overview</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Projects</span>
            <ul>
                <li>
                  <a href="/guides/projects/code-reloading">Code Reloading</a>
                </li>
                <li>
                  <a href="/guides/projects/rake">Rake</a>
                </li>
                <li>
                  <a href="/guides/projects/logging">Logging</a>
                </li>
                <li>
                  <a href="/guides/projects/initializers">Initializers</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Routing</span>
            <ul>
                <li>
                  <a href="/guides/routing/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/routing/basic-usage">Basic Usage</a>
                </li>
                <li>
                  <a href="/guides/routing/restful-resources">RESTful Resource(s)</a>
                </li>
                <li>
                  <a href="/guides/routing/testing">Testing</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Actions</span>
            <ul>
                <li>
                  <a href="/guides/actions/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/actions/basic-usage">Basic Usage</a>
                </li>
                <li>
                  <a href="/guides/actions/parameters">Parameters</a>
                </li>
                <li>
                  <a href="/guides/actions/request-and-response">Request & Response</a>
                </li>
                <li>
                  <a href="/guides/actions/exposures">Exposures</a>
                </li>
                <li>
                  <a href="/guides/actions/rack-integration">Rack Integration</a>
                </li>
                <li>
                  <a href="/guides/actions/mime-types">MIME Types</a>
                </li>
                <li>
                  <a href="/guides/actions/cookies">Cookies</a>
                </li>
                <li>
                  <a href="/guides/actions/sessions">Sessions</a>
                </li>
                <li>
                  <a href="/guides/actions/exception-handling">Exception Handling</a>
                </li>
                <li>
                  <a href="/guides/actions/control-flow">Control Flow</a>
                </li>
                <li>
                  <a href="/guides/actions/http-caching">HTTP Caching</a>
                </li>
                <li>
                  <a href="/guides/actions/share-code">Share Code</a>
                </li>
                <li>
                  <a href="/guides/actions/testing">Testing</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Views</span>
            <ul>
                <li>
                  <a href="/guides/views/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/views/basic-usage">Basic Usage</a>
                </li>
                <li>
                  <a href="/guides/views/templates">Templates</a>
                </li>
                <li>
                  <a href="/guides/views/mime-types">MIME Types</a>
                </li>
                <li>
                  <a href="/guides/views/layouts">Layouts</a>
                </li>
                <li>
                  <a href="/guides/views/custom-error-pages">Custom Error Pages</a>
                </li>
                <li>
                  <a href="/guides/views/share-code">Share Code</a>
                </li>
                <li>
                  <a href="/guides/views/testing">Testing</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Models</span>
            <ul>
                <li>
                  <a href="/guides/models/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/models/database-configuration">Database Configuration</a>
                </li>
                <li>
                  <a href="/guides/models/repositories">Repositories</a>
                </li>
                <li>
                  <a href="/guides/models/entities">Entities</a>
                </li>
                <li>
                  <a href="/guides/models/data-types">Data Types</a>
                </li>
                <li>
                  <a href="/guides/models/postgresql">PostgreSQL</a>
                </li>
                <li>
                  <a href="/guides/models/associations">Associations</a>
                </li>
                <li>
                  <a href="/guides/models/use-your-own-orm">Use Your Own ORM</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Migrations</span>
            <ul>
                <li>
                  <a href="/guides/migrations/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/migrations/create-table">Create Table</a>
                </li>
                <li>
                  <a href="/guides/migrations/alter-table">Alter Table</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Helpers</span>
            <ul>
                <li>
                  <a href="/guides/helpers/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/helpers/html5">HTML5</a>
                </li>
                <li>
                  <a href="/guides/helpers/forms">Forms</a>
                </li>
                <li>
                  <a href="/guides/helpers/routing">Routing</a>
                </li>
                <li>
                  <a href="/guides/helpers/assets">Assets</a>
                </li>
                <li>
                  <a href="/guides/helpers/links">Links</a>
                </li>
                <li>
                  <a href="/guides/helpers/escape">Markup Escape</a>
                </li>
                <li>
                  <a href="/guides/helpers/numbers">Numbers</a>
                </li>
                <li>
                  <a href="/guides/helpers/custom-helpers">Custom Helpers</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Mailers</span>
            <ul>
                <li>
                  <a href="/guides/mailers/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/mailers/basic-usage">Basic Usage</a>
                </li>
                <li>
                  <a href="/guides/mailers/templates">Templates</a>
                </li>
                <li>
                  <a href="/guides/mailers/delivery">Delivery</a>
                </li>
                <li>
                  <a href="/guides/mailers/share-code">Share Code</a>
                </li>
                <li>
                  <a href="/guides/mailers/testing">Testing</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Assets</span>
            <ul>
                <li>
                  <a href="/guides/assets/overview">Overview</a>
                </li>
                <li>
                  <a href="/guides/assets/preprocessors">Preprocessors</a>
                </li>
                <li>
                  <a href="/guides/assets/compressors">Compressors</a>
                </li>
                <li>
                  <a href="/guides/assets/content-delivery-network">Content Delivery Network (CDN)</a>
                </li>
                <li>
                  <a href="/guides/assets/use-your-own-assets-management-tool">Use Your Own Assets Management Tool</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Command Line</span>
            <ul>
                <li>
                  <a href="/guides/command-line/applications">Applications</a>
                </li>
                <li>
                  <a href="/guides/command-line/generators">Generators</a>
                </li>
                <li>
                  <a href="/guides/command-line/destroy">Destroy</a>
                </li>
                <li>
                  <a href="/guides/command-line/database">Database</a>
                </li>
                <li>
                  <a href="/guides/command-line/assets">Assets</a>
                </li>
                <li>
                  <a href="/guides/command-line/routes">Routes</a>
                </li>
                <li>
                  <a href="/guides/command-line/version">Version</a>
                </li>
            </ul>
          </li>
          <li class="toc-group">
            <span>Upgrade Notes</span>
            <ul>
                <li>
                  <a href="/guides/upgrade-notes/v060">v0.6.0</a>
                </li>
                <li>
                  <a href="/guides/upgrade-notes/v070">v0.7.0</a>
                </li>
                <li>
                  <a href="/guides/upgrade-notes/v080">v0.8.0</a>
                </li>
                <li>
                  <a href="/guides/upgrade-notes/v090">v0.9.0</a>
                </li>
            </ul>
          </li>
      </ul>

      
      <h1 id="testing" class="title"><a name="testing" class="anchor" href="#testing">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Testing</h1>
    
<p>Hanami pays a lot of attention to code testability and it offers advanced features to make our lives easier.
The framework supports Minitest (default) and RSpec.</p>

      <h2 id="unit-tests" class="title"><a name="unit-tests" class="anchor" href="#unit-tests">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Unit Tests</h2>
    
<p>First of all, actions can be unit tested.
That means we can instantiate, exercise and verify expectations <strong>directly on actions instances</strong>.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/dashboard/index_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/dashboard/index'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Dashboard</span><span class="o">::</span><span class="no">Index</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span> <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Dashboard</span><span class="o">::</span><span class="no">Index</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="p">{</span> <span class="no">Hash</span><span class="p">[]</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span> <span class="mi">200</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In the example above, <code>action</code> is an instance of <code>Web::Controllers::Dashboard::Index</code>, we can invoke <code>#call</code> on it, passing a Hash of parameters.
The <a href="/guides/actions/rack-integration">implicit returning value</a> is a serialized Rack response.
We&#39;re asserting that the status code (<code>response[0]</code>) is successful (equals to <code>200</code>).</p>

      <h3 id="running-tests" class="title"><a name="running-tests" class="anchor" href="#running-tests">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Running Tests</h3>
    
<p>We can run the entire test suite or a single file.</p>

<p>The default Rake task for the application serves for our first case: <code>bundle exec rake</code>.
All the dependencies and the application code (actions, views, entities, etc..) are eagerly loaded.
<strong>Boot time is slow in this case.</strong></p>

<p class="notice">
The entire test suite can be run via default Rake task. It loads all the dependencies, and the application code.
</p>

<p>The second scenario can be done via: <code>ruby -Ispec spec/web/controllers/dashboard/index_spec.rb</code> (or <code>rspec spec/web/controllers/dashboard/index_spec.rb</code> if we use RSpec).
When we run a single file example <strong>only the framework and the application settings are loaded</strong>.</p>

<p>Please note the <code>require_relative</code> line in the example.
It&#39;s <strong>auto generated for us</strong> and it&#39;s needed to load the current action under test.
This mechanism allows us to run unit tests in <strong>isolation</strong>.
<strong>Boot time is magnitudes faster</strong>.</p>

<p class="notice">
A single unit test can be run directly. It only loads the dependencies, but not the application code.
The class under test is loaded via <code>require_relative</code>, a line automatically generated for us.
In this way we can have a faster startup time and a shorter feedback cycle.
</p>

      <h3 id="params" class="title"><a name="params" class="anchor" href="#params">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Params</h3>
    
<p>When testing an action, we can easily simulate parameters and headers coming from the request.
We just need to pass them as a Hash.
Headers for Rack env such as <code>HTTP_ACCEPT</code> can be mixed with params like <code>:id</code>.</p>

<p>The following test example uses both.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:format</span><span class="p">)</span>  <span class="p">{</span> <span class="s1">'application/json'</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'23'</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="n">user_id</span><span class="p">,</span> <span class="s1">'HTTP_ACCEPT'</span> <span class="o">=&gt;</span> <span class="nb">format</span><span class="p">)</span>

    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span>                 <span class="mi">200</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'Content-Type'</span><span class="p">].</span><span class="nf">must_equal</span> <span class="s2">"</span><span class="si">#{</span> <span class="nb">format</span> <span class="si">}</span><span class="s2">; charset=utf-8"</span>
    <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">must_equal</span>                 <span class="p">[</span><span class="s2">"ID: </span><span class="si">#{</span> <span class="n">user_id</span> <span class="si">}</span><span class="s2">"</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Here the corresponding production code.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="nb">puts</span> <span class="n">params</span><span class="p">.</span><span class="nf">class</span> <span class="c1"># =&gt; Web::Controllers::Users::Show::Params</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="s2">"ID: </span><span class="si">#{</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
Simulating request params and headers is simple for Hanami actions. We pass them as a <code>Hash</code> and they are transformed into an instance of <code>Hanami::Action::Params</code>.
</p>

      <h3 id="exposures" class="title"><a name="exposures" class="anchor" href="#exposures">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Exposures</h3>
    
<p>There are cases where we want to verify the internal state of an action.
Imagine we have a classic user profile page, like depicted in the example above.
The action asks for a record that corresponds to the given id, and then set a <code>@user</code> instance variable.
How do we verify that the record is the one that we are looking for?</p>

<p>Because we want to make <code>@user</code> available to the outside world, we&#39;re going to use an <a href="/guides/actions/exposures"><em>exposure</em></a>.
They are used to pass a data payload between an action and the corresponding view.
When we do <code>expose :user</code>, Hanami creates a getter (<code>#user</code>), so we can easily assert if the record is the right one.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">expose</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:foo</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="vi">@foo</span>  <span class="o">=</span> <span class="s1">'bar'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We have used two <em>exposures</em>: <code>:user</code> and <code>:foo</code>, let&#39;s verify if they are properly set.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="n">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

    <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">must_equal</span> <span class="mi">200</span>

    <span class="n">action</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">must_equal</span> <span class="vi">@user</span>
    <span class="n">action</span><span class="p">.</span><span class="nf">exposures</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">({</span><span class="ss">user: </span><span class="vi">@user</span><span class="p">,</span> <span class="ss">foo: </span><span class="s1">'bar'</span><span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
The internal state of an action can be easily verified with <em>exposures</em>.
</p>

      <h3 id="dependency-injection" class="title"><a name="dependency-injection" class="anchor" href="#dependency-injection">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Dependency Injection</h3>
    
<p>During unit testing, we may want to use mocks to make tests faster or to avoid hitting external systems like databases, file system or remote services.
Because we can instantiate actions during tests, there is no need to use testing antipatterns (eg. <code>any_instance_of</code>, or <code>UserRepository.new.stub(:find)</code>).
Instead, we can just specify which collaborators we want to use via <em>dependency injection</em>.</p>

<p>Let&#39;s rewrite the test above so that it does not hit the database.
We&#39;re going to use RSpec for this example as it has a nicer API for mocks (doubles).</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/controllers/users/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/controllers/users/show'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:action</span><span class="p">)</span>     <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Controllers</span><span class="o">::</span><span class="no">Users</span><span class="o">::</span><span class="no">Show</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">repository: </span><span class="n">repository</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>       <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">id: </span><span class="mi">23</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:repository</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'repository'</span><span class="p">,</span> <span class="ss">find: </span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">id: </span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">to</span>      <span class="n">eq</span> <span class="mi">200</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="nf">user</span><span class="p">).</span><span class="nf">to</span>      <span class="n">eq</span> <span class="n">user</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="nf">exposures</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">({</span><span class="ss">user: </span><span class="n">user</span><span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We have injected the repository dependency which is a mock in our case.
Here how to adapt our action.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">expose</span> <span class="ss">:user</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">repository: </span><span class="no">UserRepository</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
      <span class="vi">@repository</span> <span class="o">=</span> <span class="n">repository</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="vi">@repository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="warning">
Please be careful using doubles in unit tests. Always verify that the mocks are in a true representation of the corresponding production code.
</p>

      <h2 id="requests-tests" class="title"><a name="requests-tests" class="anchor" href="#requests-tests">      <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16">
      <path d="M4 9h1v1h-1c-1.5 0-3-1.69-3-3.5s1.55-3.5 3-3.5h4c1.45 0 3 1.69 3 3.5 0 1.41-0.91 2.72-2 3.25v-1.16c0.58-0.45 1-1.27 1-2.09 0-1.28-1.02-2.5-2-2.5H4c-0.98 0-2 1.22-2 2.5s1 2.5 2 2.5z m9-3h-1v1h1c1 0 2 1.22 2 2.5s-1.02 2.5-2 2.5H9c-0.98 0-2-1.22-2-2.5 0-0.83 0.42-1.64 1-2.09v-1.16c-1.09 0.53-2 1.84-2 3.25 0 1.81 1.55 3.5 3 3.5h4c1.45 0 3-1.69 3-3.5s-1.5-3.5-3-3.5z"></path>
      </svg>
</a>Requests Tests</h2>
    
<p>Unit tests are a great tool to assert that low level interfaces work as expected.
We always advise combining them with integration tests.</p>

<p>In the case of Hanami web applications, we can write features (aka acceptance tests) with Capybara, but what do we use when we are building HTTP APIs?
The tool that we suggest is <code>rack-test</code>.</p>

<p>Imagine we have an API application mounted at <code>/api/v1</code> in our <code>Hanami::Container</code>.</p>
<pre class="language-ruby ruby"><code><span class="c1"># config/environment.rb</span>
<span class="c1"># ...</span>
<span class="no">Hanami</span><span class="o">::</span><span class="no">Container</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">mount</span> <span class="no">ApiV1</span><span class="o">::</span><span class="no">Application</span><span class="p">,</span> <span class="ss">at: </span><span class="s1">'/api/v1'</span>
  <span class="n">mount</span> <span class="no">Web</span><span class="o">::</span><span class="no">Application</span><span class="p">,</span>   <span class="ss">at: </span><span class="s1">'/'</span>
<span class="k">end</span>
</code></pre>

<p>Then we have the following action.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/api_v1/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">ApiV1::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">ApiV1</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">accept</span> <span class="ss">:json</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">to_h</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In this case we don&#39;t care too much about the internal state of the action, but about the output visible to the external world.
This is why we haven&#39;t set <code>user</code> as an instance variable and why we haven&#39;t exposed it.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/api_v1/requests/users_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"API V1 users"</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Luca'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># app is required by Rack::Test</span>
  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Hanami</span><span class="p">.</span><span class="nf">app</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"is successful"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/api/v1/users/</span><span class="si">#{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="si">}</span><span class="s2">"</span>

    <span class="n">last_response</span><span class="p">.</span><span class="nf">must_be</span> <span class="ss">:ok?</span>
    <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">to_h</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p class="notice">
Please avoid <em>test doubles</em> when writing full integration tests, as we want to verify that the whole stack is behaving as expected.
</p>


      <hr>

      <div class="pull-left">Prev: <a href="/guides/actions/share-code">Actions - Share Code</a></div><div class="pull-right">Next: <a href="/guides/views/overview">Views - Overview</a></div>
    </div>

    <div id="lotus" class="text-xs-center">
  <div class="container">
    <div class="row">
      Looking for <strong>Lotus</strong>? We renamed the project and it's now called <strong>Hanami</strong>. Read the <a href="/blog/2016/01/22/lotus-is-now-hanami.html">announcement</a>.
    </div>
  </div>
</div>


<div class="block app-block-footer">
  <div class="container">
    <div class="row">
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <li><h6 class="text-uppercase">Project</h6></li>
          <li><a href="https://github.com/hanami" target="_blank">GitHub</a></li>
          <li><a href="https://twitter.com/hanamirb" target="_blank">Twitter</a></li>
          <li><a href="https://rubygems.org/gems/hanami" target="_blank">Rubygems</a></li>
          <li><a href="/status" target="_blank">Gems Status</a></li>
        </ul>
      </div>
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <li><h6 class="text-uppercase">Community</h6></li>
          <li><a href="/community#code-of-conduct">Code of Conduct</a></li>
          <li><a href="http://chat.hanamirb.org" target="_blank">Chat</a></li>
          <li><a href="https://discourse.hanamirb.org" target="_blank">Forum</a></li>
          <li><a href="https://stackoverflow.com/questions/tagged/hanami" target="_blank">StackOverflow</a></li>
          <li><a href="/mailing-list">Mailing List</a></li>
          <li><a href="http://awesome-hanami.org" target="_blank">Awesome List</a></li>
        </ul>
      </div>
      <div class="col-sm-2 m-b">
        <ul class="list-unstyled list-spaced">
          <a href="http://dnsimple.link/resolving-hanami" target="_blank">
            <span>Resolving with<br/></span>
            <img src="https://cdn.dnsimple.com/assets/resolving-with-us/logo-dark.png" alt="DNSimple" style="display:block;margin:0;padding:0;width:100px;"/>
          </a>
        </ul>
      </div>
      <div class="col-sm-6">
        <h6 class="text-uppercase">About</h6>
        <p>
          Hanami is a web framework for Ruby &mdash; &copy; 2014-2017 <a href="http://lucaguidi.com" target="_blank">Luca Guidi</a>.<br>
          Released under the <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>.
          <br><br>
          This project was formerly known as <strong>Lotus</strong>.
        </p>
      </div>
    </div>
  </div>
</div>
<script src="/javascripts/jquery.min.js" type="text/javascript"></script>
<script src="/javascripts/toolkit.js" type="text/javascript"></script>
<script src="/javascripts/application.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47369640-1', 'hanamirb.org');
  ga('send', 'pageview');
</script>

<script>
  ((window.gitter = {}).chat = {}).options = { room: 'hanami/chat' };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  </body>
</html>
