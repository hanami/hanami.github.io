<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Lotus - Guides - Action HTTP Caching</title>
    <meta name="description" content="Lotus, a complete web framework for Ruby" />
    <meta name="keywords" content="lotus,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://feeds.feedburner.com/lotusrb" rel="alternate" title="Lotus" type="application/atom+xml" />

    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />

    <script src="//use.typekit.net/xhp5wmc.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body class="subpage docs">
    <!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<nav class="navbar navbar-fixed-top container-fluid">
  <div class="wrapper container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Logo</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <!-- <li><a href="/guides">Guides</a></li> -->
        <li><a href="/community">Community</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://rubygems.org/gems/lotusrb" id="nav-link-install" target="_blank" class="btn btn-primary version">Install v0.3.2</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <section class="docs wrapper animated fadeIn">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3 hidden-sm hidden-xs sidebar">
            <ul class="nav nav-sidebar">
              <li>
                <span class="heading">Routing</span>
                <ul class="nav">
                  <li><a href="/guides/routing/overview">Overview</a></li>
                  <li><a href="/guides/routing/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/routing/restful-resources">RESTful Resource(s)</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Actions</span>
                <ul class="nav">
                  <li><a href="/guides/actions/overview">Overview</a></li>
                  <li><a href="/guides/actions/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/actions/parameters">Parameters</a></li>
                  <li><a href="/guides/actions/request-and-response">Request & Response</a></li>
                  <li><a href="/guides/actions/exposures">Exposures</a></li>
                  <li><a href="/guides/actions/rack-integration">Rack Integration</a></li>
                  <li><a href="/guides/actions/mime-types">MIME Types</a></li>
                  <li><a href="/guides/actions/cookies">Cookies</a></li>
                  <li><a href="/guides/actions/sessions">Sessions</a></li>
                  <li><a href="/guides/actions/exception-handling">Exception Handling</a></li>
                  <li><a href="/guides/actions/control-flow">Control Flow</a></li>
                  <li><a href="/guides/actions/http-caching">HTTP Caching</a></li>
                  <li><a href="/guides/actions/share-code">Share Code</a></li>
                  <li><a href="/guides/actions/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Views</span>
                <ul class="nav">
                  <li><a href="/guides/views/overview">Overview</a></li>
                  <li><a href="/guides/views/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/views/templates">Templates</a></li>
                  <li><a href="/guides/views/partials">Partials</a></li>
                  <li><a href="/guides/views/mime-types">MIME Types</a></li>
                  <li><a href="/guides/views/layouts">Layouts</a></li>
                  <li><a href="/guides/views/custom-error-pages">Custom Error Pages</a></li>
                  <li><a href="/guides/views/share-code">Share Code</a></li>
                  <li><a href="/guides/views/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Helpers</span>
                <ul class="nav">
                  <li><a href="/guides/helpers/overview">Overview</a></li>
                  <li><a href="/guides/helpers/html5">HTML5</a></li>
                  <li><a href="/guides/helpers/forms">Forms</a></li>
                  <li><a href="/guides/helpers/routing">Routing</a></li>
                  <li><a href="/guides/helpers/links">Links</a></li>
                  <li><a href="/guides/helpers/escape">Markup Escape</a></li>
                  <li><a href="/guides/helpers/numbers">Numbers</a></li>
                  <li><a href="/guides/helpers/custom-helpers">Custom Helpers</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Command Line</span>
                <ul class="nav">
                  <li><a href="/guides/command-line/routes">Routes</a></li>
                </ul>
              </li>
            </ul>

          </div>

          <div class="col-md-9 main">
            <div class="doc-section">
              <a href="https://github.com/lotus/lotus.github.io/edit/build//source/guides/actions/http-caching.md" id="edit-guides-article" title="Edit this article" target="_blank">edit</a>
              <h1>HTTP Caching</h1>

<p>We refer to HTTP caching as the set of techiniques for HTTP 1.1 and implemented by browser vendors in order to make faster interactions with the server.
There are a few headers that if sent, will enable these mechanisms.</p>

<p>Because these are advanced features, they must be enabled via <code>http_caching true</code> in our application settings (<code>apps/web/application.rb</code>).</p>

<h2>Cache Control</h2>

<p>Actions offer a DSL to set a special header <code>Cache-Control</code>.
The first argument is a cache response directive like <code>:public</code> or <code>&quot;must-revalidate&quot;</code>, while the second argument is a set of options like <code>:max_age</code>.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/dashboard/index.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Dashboard</span>
  <span class="k">class</span> <span class="nc">Index</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>

    <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">max_age: </span><span class="mi">600</span>
      <span class="c1"># =&gt; Cache-Control: public, max-age: 600</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h2>Expires</h2>

<p>Another HTTP caching special header is: <code>Expires</code>.
It can be used for retrocompatibility with old browsers which don&rsquo;t understand <code>Cache-Control</code>.</p>

<p>Lotus&rsquo; solution for <em>expire</em> combines support for all the browsers, by sending both the headers.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/dashboard/index.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Dashboard</span>
  <span class="k">class</span> <span class="nc">Index</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>
    <span class="n">expires</span> <span class="mi">60</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">max_age: </span><span class="mi">300</span>
      <span class="c1"># =&gt; Expires: Mon, 18 May 2015 09:19:18 GMT</span>
      <span class="c1">#    Cache-Control: public, max-age: 300</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h2>Conditional GET</h2>

<p><em>Conditional GET</em> is a two step workflow to inform browsers that a resource hasn&rsquo;t changed since the last visit.
At the end of the first request, it receives special HTTP response headers to send back the next time it will come back.
If that header matches the value that the server calculates, then the resource is still cached and a <code>304</code> status (Not Modified) is returned.</p>

<h3>ETag</h3>

<p>The first way to match a resource freshness is to use an identifier (usually an MD5 token).
Let&rsquo;s specify it with <code>fresh etag:</code>.</p>

<p>If the given identifier does NOT match <code>If-None-Match</code> request header, it will return a <code>200</code> and set <code>ETag</code> response header with that value.
If it matches, the action will be halted and a <code>304</code> will be returned.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">fresh</span> <span class="ss">etag: </span><span class="n">etag</span>

      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">etag</span>
      <span class="s2">"</span><span class="si">#{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">id</span> <span class="si">}</span><span class="s2">-</span><span class="si">#{</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">updated_at</span> <span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Case 1 (missing or non-matching If-None-Match)</span>
<span class="c1"># GET /users/23</span>
<span class="c1">#  =&gt; 200, ETag: 84e037c89f8d55442366c4492baddeae</span>

<span class="c1"># Case 2 (matching If-None-Match)</span>
<span class="c1"># GET /users/23, If-None-Match: 84e037c89f8d55442366c4492baddeae</span>
<span class="c1">#  =&gt; 304</span>
</code></pre>

<h3>Last Modified</h3>

<p>The second way is to use a timestamp via <code>fresh last_modified:</code>.</p>

<p>If the given timestamp does NOT match <code>If-Modified-Since</code> request header, it will return a <code>200</code> and set <code>Last-Modified</code> response header with that value.
If it matches, the action will be halted and a <code>304</code> will be returned.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/controllers/users/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Controllers::Users</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">Action</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">UserRepository</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
      <span class="n">fresh</span> <span class="ss">last_modified: </span><span class="vi">@user</span><span class="p">.</span><span class="nf">updated_at</span>

      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Case 1 (missing or non-matching Last-Modified)</span>
<span class="c1"># GET /users/23</span>
<span class="c1">#  =&gt; 200, Last-Modified: Mon, 18 May 2015 10:04:30 GMT</span>

<span class="c1"># Case 2 (matching Last-Modified)</span>
<span class="c1"># GET /users/23, If-Modified-Since: Mon, 18 May 2015 10:04:30 GMT</span>
<span class="c1">#  =&gt; 304</span>
</code></pre>

            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="email-signup">
  <div class="container-fluid wrapper">
    <form action="http://lotusrb.us3.list-manage.com/subscribe/post" method="POST" class="">
      <input name="u" value="dcbeefa4ba1ea9ae043857005" type="hidden">
      <input name="id" value="fb3873a90f" type="hidden">
      <input name="orig-lang" value="1" type="hidden">
      <input type="email" placeholder="Enter your email to get updates" spellcheck="false" autocapitalize="off" autocorrect="off" name="MERGE0" id="MERGE0" value="" class="pull-left">
      <button type="submit" class="btn btn-primary pull-right">Subscribe</button>
    </form>
  </div>
</section>

<footer class="primary">
  <div class="container-fluid wrapper">
    <div class="row">
      <a class="logo col-md-3" href="/">logo</a>
        <div class="col-md-4">
          <span class="date">June 15, 2015</span>
          <h4>Introducing Form Helpers</h4>
          <p>New feature for the upcoming v0.4.0: form helpers. HTML5 form generators with automatic values, CSRF protection, method override, infinite nested fields and ORM agnostic.
</p>
          <a href="/blog/2015/06/15/introducing-form-helpers.html">Read more...</a>
        </div>
        <div class="col-md-4">
          <span class="date">May 31, 2015</span>
          <h4>Weekly Changelog</h4>
          <p>Changelog from May 16 2015 to May 31 2015
</p>
          <a href="/blog/2015/05/31/weekly-changelog.html">Read more...</a>
        </div>
    </div>
  </div>

  <div class="sub-footer wrapper">
    <p class="copyright pull-left">&copy; 2014-<span id="copyright-year">{{year}}</span> <a href="http://lucaguidi.com/">Luca Guidi</a> â€“ Lotus is released under the MIT License.
    <br>
    <br> This website and its contents are released under <a href="http://creativecommons.org/licenses/by-nc/4.0/" href="_blank">CC Attribution-NonCommercial 4.0</a>.
    <br> Maintained with <3 by the <a href="https://github.com/orgs/lotus/people" target="_blank">core team</a> with help from <a href="https://github.com/lotus/lotus/graphs/contributors" target="_blank">contributors</a>. Site Design by <a href="http://www.alantippins.com/">Alan Tippins</a>.</p>
    <ul class="social">
      <li><a href="https://twitter.com/lotus_rb" target="_blank" class="icon-twitter"></a></li>
      <li><a href="https://github.com/lotus" target="_blank" class="icon-github"></a></li>
    </ul>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="javascripts/vendor/jquery-1.11.2.min.js"><\/script>')</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>

<script src="/javascripts/application.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47369640-1', 'lotusrb.org');
  ga('send', 'pageview');
</script>

  </body>
</html>
