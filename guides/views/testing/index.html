<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Lotus - Guides - View Testing</title>
    <meta name="description" content="Lotus, a complete web framework for Ruby" />
    <meta name="keywords" content="lotus,web,framework,ruby,open source,oss,os,software,free,free software,architecture,fast,lightweight,testing,tdd,bdd,test driven development,behaviour driven development,full stack,mvc,model view object,pattern,patterns,design patterns,oop,object oriented programming,testability,http,https,routing,router,http router,restful,resource,resources,convention,controller,models,repository,query,sql,interactors,two-step view,view,template,presenters,render,rendering,helpers,erb,haml,tilt,json,xml,yaml,yml,framwork,framewrok,riby,free sowftare"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://feeds.feedburner.com/lotusrb" rel="alternate" title="Lotus" type="application/atom+xml" />

    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" />

    <script src="//use.typekit.net/xhp5wmc.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body class="subpage docs">
    <!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<nav class="navbar navbar-fixed-top container-fluid">
  <div class="wrapper container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Logo</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li><a href="/guides">Guides</a></li>
        <li><a href="/community">Community</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="https://rubygems.org/gems/lotusrb" id="nav-link-install" target="_blank" class="btn btn-primary version">Install v0.4.1</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>


    <section class="docs wrapper animated fadeIn">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3 hidden-sm hidden-xs sidebar">
            <ul class="nav nav-sidebar">
              <li>
                <span class="heading">Getting Started</span>
                <ul class="nav">
                  <li><a href="/guides/getting-started">Getting Started</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Architectures</span>
                <ul class="nav">
                  <li><a href="/guides/architectures/overview">Overview</a></li>
                  <li><a href="/guides/architectures/container">Container</a></li>
                  <li><a href="/guides/architectures/application">Application</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Routing</span>
                <ul class="nav">
                  <li><a href="/guides/routing/overview">Overview</a></li>
                  <li><a href="/guides/routing/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/routing/restful-resources">RESTful Resource(s)</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Actions</span>
                <ul class="nav">
                  <li><a href="/guides/actions/overview">Overview</a></li>
                  <li><a href="/guides/actions/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/actions/parameters">Parameters</a></li>
                  <li><a href="/guides/actions/request-and-response">Request & Response</a></li>
                  <li><a href="/guides/actions/exposures">Exposures</a></li>
                  <li><a href="/guides/actions/rack-integration">Rack Integration</a></li>
                  <li><a href="/guides/actions/mime-types">MIME Types</a></li>
                  <li><a href="/guides/actions/cookies">Cookies</a></li>
                  <li><a href="/guides/actions/sessions">Sessions</a></li>
                  <li><a href="/guides/actions/exception-handling">Exception Handling</a></li>
                  <li><a href="/guides/actions/control-flow">Control Flow</a></li>
                  <li><a href="/guides/actions/http-caching">HTTP Caching</a></li>
                  <li><a href="/guides/actions/share-code">Share Code</a></li>
                  <li><a href="/guides/actions/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Views</span>
                <ul class="nav">
                  <li><a href="/guides/views/overview">Overview</a></li>
                  <li><a href="/guides/views/basic-usage">Basic Usage</a></li>
                  <li><a href="/guides/views/templates">Templates</a></li>
                  <li><a href="/guides/views/mime-types">MIME Types</a></li>
                  <li><a href="/guides/views/layouts">Layouts</a></li>
                  <li><a href="/guides/views/custom-error-pages">Custom Error Pages</a></li>
                  <li><a href="/guides/views/share-code">Share Code</a></li>
                  <li><a href="/guides/views/testing">Testing</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Models</span>
                <ul class="nav">
                  <li><a href="/guides/models/overview">Overview</a></li>
                  <li><a href="/guides/models/entities">Entities</a></li>
                  <li><a href="/guides/models/repositories">Repositories</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Migrations</span>
                <ul class="nav">
                  <li><a href="/guides/migrations/overview">Overview</a></li>
                  <li><a href="/guides/migrations/create-table">Create Table</a></li>
                  <li><a href="/guides/migrations/alter-table">Alter Table</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Helpers</span>
                <ul class="nav">
                  <li><a href="/guides/helpers/overview">Overview</a></li>
                  <li><a href="/guides/helpers/html5">HTML5</a></li>
                  <li><a href="/guides/helpers/forms">Forms</a></li>
                  <li><a href="/guides/helpers/routing">Routing</a></li>
                  <li><a href="/guides/helpers/links">Links</a></li>
                  <li><a href="/guides/helpers/escape">Markup Escape</a></li>
                  <li><a href="/guides/helpers/numbers">Numbers</a></li>
                  <li><a href="/guides/helpers/custom-helpers">Custom Helpers</a></li>
                </ul>
              </li>

              <li>
                <span class="heading">Command Line</span>
                <ul class="nav">
                  <li><a href="/guides/command-line/applications">Applications</a></li>
                  <li><a href="/guides/command-line/generators">Generators</a></li>
                  <li><a href="/guides/command-line/database">Database</a></li>
                  <li><a href="/guides/command-line/routes">Routes</a></li>
                  <li><a href="/guides/command-line/version">Version</a></li>
                </ul>
              </li>
            </ul>

          </div>

          <div class="col-md-9 main">
            <div class="doc-section">
              <a href="https://github.com/lotus/lotus.github.io/edit/build//source/guides/views/testing.md" id="edit-guides-article" title="Edit this article" target="_blank">edit</a>
              <h1>View Testing</h1>

<p>One of the advantages of views as objects is that we can unit test them.
We can both understand if a specific presentational logic behaves correctly and/or assert if the rendered markup.</p>

<p>For the following example we&rsquo;re gonna use RSpec for the concise syntax for test doubles.</p>
<pre class="language-ruby ruby"><code><span class="c1"># spec/web/views/books/show_spec.rb</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../../../apps/web/views/books/show'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Web</span><span class="o">::</span><span class="no">Views</span><span class="o">::</span><span class="no">Books</span><span class="o">::</span><span class="no">Show</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:exposures</span><span class="p">)</span> <span class="p">{</span> <span class="no">Hash</span><span class="p">[</span><span class="ss">book: </span><span class="n">double</span><span class="p">(</span><span class="s1">'book'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">1</span><span class="o">.</span><span class="mo">00</span><span class="p">),</span> <span class="ss">current_user: </span><span class="n">user</span><span class="p">]</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:template</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Lotus</span><span class="o">::</span><span class="no">View</span><span class="o">::</span><span class="no">Template</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'apps/web/templates/books/show.html.erb'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:view</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Web</span><span class="o">::</span><span class="no">Views</span><span class="o">::</span><span class="no">Home</span><span class="o">::</span><span class="no">Another</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">exposures</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:rendered</span><span class="p">)</span>  <span class="p">{</span> <span class="n">view</span><span class="p">.</span><span class="nf">render</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>      <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="n">admin?</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"price"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns formatted price"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">view</span><span class="p">.</span><span class="nf">formatted_price</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"$1.00"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"edit link"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"doesn't show it by default"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">rendered</span><span class="p">).</span><span class="nf">to_not</span> <span class="n">match</span> <span class="sx">%(&lt;a href=""&gt;edit&lt;/a&gt;)</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s2">"when admin"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="n">admin?</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">"shows it"</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">rendered</span><span class="p">).</span><span class="nf">to</span> <span class="n">match</span> <span class="sx">%(&lt;a href=""&gt;edit&lt;/a&gt;)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>The first part of the test code above is about book&rsquo;s formatting price.
This presentational logic is verified by asserting the returning value of <code>view.formatted_price</code>.</p>

<p>The remaining code is about permissions related logic: the edit link must be rendered only if the current user is an admin.
This is tested by looking at the output of the template.</p>

<p class="notice">
  Asserting presentational logic directly via view&rsquo;s methods, or indirectly via rendered markup are two EQUIVALENT ways.
</p>

<p>Let&rsquo;s have a look at the corresponding production code.</p>
<pre class="language-ruby ruby"><code><span class="c1"># apps/web/views/books/show.rb</span>
<span class="k">module</span> <span class="nn">Web::Views::Books</span>
  <span class="k">class</span> <span class="nc">Show</span>
    <span class="kp">include</span> <span class="no">Web</span><span class="o">::</span><span class="no">View</span>

    <span class="k">def</span> <span class="nf">formatted_price</span>
      <span class="s2">"$</span><span class="si">#{</span> <span class="n">format_number</span> <span class="n">book</span><span class="p">.</span><span class="nf">price</span> <span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">edit_link</span>
      <span class="k">if</span> <span class="n">can_edit_book?</span>
        <span class="n">link_to</span> <span class="s2">"Edit"</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="nf">edit_book_path</span><span class="p">(</span><span class="ss">id: </span><span class="n">book</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">can_edit_book?</span>
      <span class="n">current_user</span><span class="p">.</span><span class="nf">admin?</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="email-signup">
  <div class="container-fluid wrapper">
    <form action="http://lotusrb.us3.list-manage.com/subscribe/post" method="POST" class="">
      <input name="u" value="dcbeefa4ba1ea9ae043857005" type="hidden">
      <input name="id" value="fb3873a90f" type="hidden">
      <input name="orig-lang" value="1" type="hidden">
      <input type="email" placeholder="Enter your email to get updates" spellcheck="false" autocapitalize="off" autocorrect="off" name="MERGE0" id="MERGE0" value="" class="pull-left">
      <button type="submit" class="btn btn-primary pull-right">Subscribe</button>
    </form>
  </div>
</section>

<footer class="primary">
  <div class="container-fluid wrapper">
    <div class="row">
      <a class="logo col-md-3" href="/">logo</a>
        <div class="col-md-4">
          <span class="date">July 10, 2015</span>
          <h4>Announcing Lotus v0.4.1</h4>
          <p>Lotus patch release: Fix container routes, Rack middleware sessions and CLI commands.
</p>
          <a href="/blog/2015/07/10/announcing-lotus-041.html">Read more...</a>
        </div>
        <div class="col-md-4">
          <span class="date">June 30, 2015</span>
          <h4>Announcing Rails Girls Summer of Code x Lotus</h4>
          <p>This year marks the first participitation of Lotus project with Rails Girls Summer of Code program to deliver the long awaited mailer feature that has been set to be released along the roadmap for version 0.5.0.
</p>
          <a href="/blog/2015/06/30/announcing-lotus-rgsoc.html">Read more...</a>
        </div>
    </div>
  </div>

  <div class="sub-footer wrapper">
    <p class="copyright pull-left">&copy; 2014-<span id="copyright-year">{{year}}</span> <a href="http://lucaguidi.com/">Luca Guidi</a> â€“ Lotus is released under the MIT License.
    <br>
    <br> This website and its contents are released under <a href="http://creativecommons.org/licenses/by-nc/4.0/" href="_blank">CC Attribution-NonCommercial 4.0</a>.
    <br> Maintained with <3 by the <a href="https://github.com/orgs/lotus/people" target="_blank">core team</a> with help from <a href="https://github.com/lotus/lotus/graphs/contributors" target="_blank">contributors</a>. Site Design by <a href="http://www.alantippins.com/">Alan Tippins</a>.</p>
    <ul class="social">
      <li><a href="https://twitter.com/lotus_rb" target="_blank" class="icon-twitter"></a></li>
      <li><a href="https://github.com/lotus" target="_blank" class="icon-github"></a></li>
    </ul>
  </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="javascripts/vendor/jquery-1.11.2.min.js"><\/script>')</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>

<script src="/javascripts/application.js" type="text/javascript"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-47369640-1', 'lotusrb.org');
  ga('send', 'pageview');
</script>

  </body>
</html>
